<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 主畫面顯示名稱 -->
  <title>輪盤</title>
  <meta name="apple-mobile-web-app-title" content="輪盤">

  <!-- ✅ App 圖示 -->
  <link rel="icon" href="./images icon.png">
  <link rel="apple-touch-icon" href="./images icon.png">

  <!-- （可選）全螢幕 App 感 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

</head>
  <style>
    :root{
      --bg: #f3efe7;
      --card: rgba(255,255,255,.55);
      --ink: #1d1d1d;
      --muted: rgba(0,0,0,.55);
      --shadow: 0 18px 40px rgba(0,0,0,.12);
      --soft-shadow: 0 10px 26px rgba(0,0,0,.10);
      --btn: #f5d98f;
      --btn2: #ffffff;
      --radius: 22px;
      --wheelSize: min(78vw, 420px);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(900px 700px at 70% 20%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(900px 900px at 50% 80%, rgba(0,0,0,.05), transparent 55%),
        var(--bg);
      color:var(--ink);
      font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 20px 14px 40px;
    }

    .wrap{ max-width: 560px; margin: 0 auto; }

    h1{
      margin: 8px 0 14px;
      text-align:center;
      font-size: 38px;
      letter-spacing: .5px;
      font-weight: 900;
    }

    .panel{
      background: var(--card);
      border: 2px solid rgba(0,0,0,.10);
      box-shadow: var(--shadow);
      border-radius: 26px;
      padding: 16px 14px 18px;
      backdrop-filter: blur(10px);
    }

    .wheelStage{
      position: relative;
      display:flex;
      justify-content:center;
      padding: 18px 0 10px;
    }

    /* 指標：尖端朝下，指向輪盤內 */
    .pointer{
      position:absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width:0; height:0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-top: 30px solid rgba(0,0,0,.85);
      filter: drop-shadow(0 6px 0 rgba(0,0,0,.12));
      z-index: 60;
    }
    .pointer::after{
      content:"";
      position:absolute;
      left:-12px;
      top:-28px;
      width:0;height:0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 20px solid #f4a63a;
    }

    .wheelWrap{
      position: relative;
      width: var(--wheelSize);
      height: var(--wheelSize);
      display:grid;
      place-items:center;
    }

    .wheel{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      transform: rotate(0deg);
      will-change: transform;
      filter: drop-shadow(0 18px 16px rgba(0,0,0,.15));
      user-select:none;
    }

    .wheel::before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 80%, rgba(0,0,0,.14), transparent 58%),
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.75), transparent 55%);
      z-index:-1;
      filter: blur(1px);
    }

    .inkRing{
      position:absolute; inset:0;
      border-radius:50%;
      border: 6px solid rgba(0,0,0,.78);
      box-shadow:
        inset 0 0 0 4px rgba(255,255,255,.35),
        inset 0 0 0 10px rgba(0,0,0,.10);
      pointer-events:none;
      z-index: 10;
    }

    .face{
      position:absolute;
      inset: 8px;
      border-radius: 50%;
      overflow:hidden;
      background: #fff;
      z-index: 1;
    }

    /* 水彩紙感顆粒 */
    .paperGrain{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 10% 20%, rgba(0,0,0,.04), transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(0,0,0,.03), transparent 40%),
        radial-gradient(circle at 30% 70%, rgba(0,0,0,.03), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(0,0,0,.03), transparent 45%);
      mix-blend-mode: multiply;
      pointer-events:none;
      opacity:.75;
      z-index: 3;
    }

    /* 分隔線：用 SVG 畫在 face 內，永遠不會分離 */
    .spokesSvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      z-index: 4;
      pointer-events:none;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
    }

    /* 文字標籤：放在 face 裡面一起轉 */
    .labels{
      position:absolute;
      inset:0;
      z-index: 5;
      pointer-events:none;
    }
    .label{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
      font-weight: 900;
      font-size: 20px;
      color: rgba(0,0,0,.80);
      text-shadow:
        0 2px 0 rgba(255,255,255,.60),
        0 0 10px rgba(255,255,255,.35);
      white-space: nowrap;
      letter-spacing:.5px;
    }

    /* 中心紅球（固定在正中心） */
    .hub{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: 54px;
      height: 54px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.90), rgba(255,255,255,.25) 35%, transparent 36%),
        radial-gradient(circle at 60% 70%, rgba(0,0,0,.14), transparent 55%),
        #d94135;
      border: 4px solid rgba(0,0,0,.80);
      z-index: 70;
      box-shadow: 0 10px 14px rgba(0,0,0,.18);
      pointer-events:none;
    }

    .btnRow{
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button{
      border: 2px solid rgba(0,0,0,.20);
      border-radius: 18px;
      padding: 12px 18px;
      font-weight: 900;
      font-size: 20px;
      background: var(--btn2);
      box-shadow: var(--soft-shadow);
      color: var(--ink);
      cursor: pointer;
    }
    button.primary{
      background: var(--btn);
      border-color: rgba(0,0,0,.18);
      min-width: 170px;
    }
    button.secondary{ min-width: 170px; }
    button.ghost{ background: rgba(255,255,255,.55); min-width: 170px; }
    button:disabled{ opacity:.45; cursor:not-allowed; filter: grayscale(.2); }

    .result{
      text-align:center;
      margin-top: 10px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.5px;
    }
    .hint{
      text-align:center;
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      line-height: 1.4;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
      padding: 10px 8px 0;
      border-top: 1px dashed rgba(0,0,0,.18);
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size: 13px; color: var(--muted); font-weight: 800; }
    .field input{
      width:100%;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.70);
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 700;
      outline: none;
    }
    .field input:focus{
      border-color: rgba(0,0,0,.28);
      box-shadow: 0 0 0 3px rgba(245,217,143,.45);
    }

    @media (max-width: 420px){
      h1{ font-size: 34px; }
      .label{ font-size: 18px; }
      button{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>今天要選什麼？</h1>

    <div class="panel">
      <div class="wheelStage">
        <div class="pointer" aria-hidden="true"></div>

        <div class="wheelWrap">
          <div class="wheel" id="wheel">
            <div class="face" id="face">
              <div class="paperGrain"></div>
              <svg class="spokesSvg" id="spokesSvg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
              <div class="labels" id="labels"></div>
            </div>

            <div class="inkRing"></div>
            <div class="hub" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnSpin" disabled>開始</button>
        <button class="secondary" id="btnApply">套用選項</button>
        <button class="ghost" id="btnClear">清空</button>
      </div>

      <div class="result" id="result">結果是：—</div>
      <div class="hint" id="hint">
        至少填 2 個選項才可開始。<br/>
        2/3/5/7 個選項會自動倍增成 4/6/8 格，避免只剩對半。
      </div>

      <div class="grid" id="inputs"></div>
    </div>
  </div>

<script>
(() => {
  const wheel = document.getElementById('wheel');
  const face  = document.getElementById('face');
  const spokesSvg = document.getElementById('spokesSvg');
  const labels = document.getElementById('labels');
  const inputs = document.getElementById('inputs');
  const btnSpin = document.getElementById('btnSpin');
  const btnApply = document.getElementById('btnApply');
  const btnClear = document.getElementById('btnClear');
  const resultEl = document.getElementById('result');

  // 8 格輸入
  const inputEls = [];
  for (let i=1;i<=8;i++){
    const wrap = document.createElement('div');
    wrap.className = 'field';
    wrap.innerHTML = `
      <label>選項 ${i}</label>
      <input type="text" autocomplete="off" placeholder="例如：火鍋" />
    `;
    const inp = wrap.querySelector('input');
    inp.addEventListener('input', () => updateStartState());
    inputEls.push(inp);
    inputs.appendChild(wrap);
  }

  const baseColors = [
    '#f6d36a',
    '#bfe7d0',
    '#bfe0f6',
    '#c9c1f6',
    '#f2c2d7',
    '#f3d7b7',
    '#c8f0c2',
    '#bfeff0',
  ];

  let currentOptions = [];
  let segmentCount = 6;
  let isSpinning = false;
  let rotation = 0; // deg

  function normalizeText(s){ return (s ?? '').trim(); }
  function getRawOptions(){
    return inputEls.map(i => normalizeText(i.value)).filter(Boolean);
  }

  function expandOptions(raw){
    const n = raw.length;
    if (n < 2) return { opts: [], count: 0 };

    let target;
    if (n === 2) target = 4;
    else if (n === 3) target = 6;
    else if (n === 4) target = 4;
    else if (n === 5) target = 8;
    else if (n === 6) target = 6;
    else if (n === 7) target = 8;
    else target = 8;

    const out = [];
    for (let i=0;i<target;i++) out.push(raw[i % n]);
    return { opts: out, count: target };
  }

  // 更「有期待感」的減速：前面很快，後面拖很久才停
  function easeOutQuint(t){
    return 1 - Math.pow(1 - t, 5);
  }

  /*
    ✅ 這裡是關鍵修正：

    你的底色是 conic-gradient(from -90deg ...)
    代表第 0 格的「中心角」是：-90 + seg/2
    指針也在正上方（-90 的方向）

    所以要讓第 idx 格中心對準指針：
      (中心角 + rotation) = -90
      rotation = -90 - ( -90 + seg/2 + idx*seg )
               = - ( idx*seg + seg/2 )

    之前你用 90 - (...) 會對到別的位置，所以才會指針≠結果
  */
  function rotationForIndexCenter(idx){
    const seg = 360 / segmentCount;
    return -(idx * seg + seg/2);
  }

  // 取得「向前(順時針)」最小補角，確保一直往同方向旋轉
  function deltaForward(currentDeg, targetDeg){
    const cur = ((currentDeg % 360) + 360) % 360;
    const tar = ((targetDeg % 360) + 360) % 360;
    let d = tar - cur;
    if (d < 0) d += 360;
    return d;
  }

  function buildGradient(opts){
    const seg = 360 / opts.length;
    const stops = [];
    for (let i=0;i<opts.length;i++){
      const c = baseColors[i % baseColors.length];
      const a0 = (i * seg).toFixed(3);
      const a1 = ((i+1) * seg).toFixed(3);
      stops.push(`${c} ${a0}deg ${a1}deg`);
    }
    face.style.background = `conic-gradient(from -90deg, ${stops.join(',')})`;
  }

  function buildSpokes(count){
    spokesSvg.innerHTML = '';
    const seg = 360 / count;

    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute('cx', '50');
    circle.setAttribute('cy', '50');
    circle.setAttribute('r', '49');
    circle.setAttribute('fill', 'none');
    circle.setAttribute('stroke', 'rgba(0,0,0,.20)');
    circle.setAttribute('stroke-width', '1.6');
    spokesSvg.appendChild(circle);

    for (let i=0;i<count;i++){
      const ang = (i * seg - 90) * Math.PI / 180;
      const x = 50 + Math.cos(ang) * 49;
      const y = 50 + Math.sin(ang) * 49;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute('x1', '50');
      line.setAttribute('y1', '50');
      line.setAttribute('x2', String(x));
      line.setAttribute('y2', String(y));
      line.setAttribute('stroke', 'rgba(0,0,0,.55)');
      line.setAttribute('stroke-width', '1.9');
      line.setAttribute('stroke-linecap', 'round');
      spokesSvg.appendChild(line);
    }
  }

  function buildLabels(opts){
    labels.innerHTML = '';
    const count = opts.length;
    const seg = 360 / count;

    const radius = 0.62;
    const wheelPx = wheel.clientWidth;

    for (let i=0;i<count;i++){
      const angle = i * seg + seg/2 - 90;
      const lab = document.createElement('div');
      lab.className = 'label';
      lab.textContent = opts[i];

      lab.style.transform =
        `rotate(${angle}deg) translate(${(wheelPx/2)*radius}px) rotate(${-angle}deg) translate(-50%, -50%)`;

      labels.appendChild(lab);
    }
  }

  function renderWheel(opts){
    segmentCount = opts.length;
    buildGradient(opts);
    buildSpokes(segmentCount);
    buildLabels(opts);
  }

  function applyOptions(){
    const raw = getRawOptions();
    const { opts, count } = expandOptions(raw);

    if (count < 2){
      currentOptions = [];
      resultEl.textContent = '結果是：—';
      renderWheel(['請填至少兩個']);
      wheel.style.opacity = 0.85;
      btnSpin.disabled = true;
      return;
    }

    currentOptions = opts.slice();
    wheel.style.opacity = 1;
    renderWheel(currentOptions);
    resultEl.textContent = '結果是：—';
    updateStartState();
  }

  function updateStartState(){
    const raw = getRawOptions();
    btnSpin.disabled = isSpinning || raw.length < 2 || currentOptions.length < 2;
  }

  function spin(){
    if (isSpinning) return;
    if (currentOptions.length < 2) return;

    isSpinning = true;
    btnSpin.disabled = true;
    btnApply.disabled = true;
    btnClear.disabled = true;

    const count = segmentCount;

    // 隨機目標 index（最後顯示的結果就用它）
    const targetIndex = Math.floor(Math.random() * count);

    const start = rotation;

    // ✅ 目標停止角：讓「該格中心」精準對準「上方指針」
    const targetBase = rotationForIndexCenter(targetIndex);

    // 多圈：拉長期待感（越多圈越爽）
    const extraTurns = (8 + Math.floor(Math.random()*6)) * 360;

    // 永遠往同一方向旋轉（順時針）
    const delta = deltaForward(start, targetBase);
    const end = start + extraTurns + delta;

    // ✅ 轉更久、後段更慢
    const duration = 4600 + Math.floor(Math.random()*900);

    const t0 = performance.now();

    function tick(now){
      const t = Math.min(1, (now - t0) / duration);
      const eased = easeOutQuint(t);

      rotation = start + (end - start) * eased;
      wheel.style.transform = `rotate(${rotation}deg)`;

      if (t < 1){
        requestAnimationFrame(tick);
      } else {
        // ✅ 最後直接「鎖死」到 end，確保角度完全精準
        rotation = end;
        wheel.style.transform = `rotate(${rotation}deg)`;

        // ✅ 結果必定 = 指針指到的那一格
        resultEl.textContent = `結果是：${currentOptions[targetIndex]}`;

        isSpinning = false;
        btnApply.disabled = false;
        btnClear.disabled = false;
        updateStartState();
      }
    }

    requestAnimationFrame(tick);
  }

  function clearAll(){
    inputEls.forEach(i => i.value = '');
    currentOptions = [];
    rotation = 0;
    wheel.style.transform = `rotate(0deg)`;
    resultEl.textContent = '結果是：—';
    renderWheel(['請填至少兩個']);
    wheel.style.opacity = 0.85;
    btnSpin.disabled = true;
    btnApply.disabled = false;
    btnClear.disabled = false;
  }

  btnApply.addEventListener('click', applyOptions);
  btnSpin.addEventListener('click', spin);
  btnClear.addEventListener('click', clearAll);

  // 初始
  renderWheel(['請填至少兩個']);
  wheel.style.opacity = 0.85;
})();
</script>
</body>
</html>
