<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>今天要選什麼？｜手繪轉盤</title>

  <!-- 內嵌 favicon（輪盤） -->
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
    <defs>
      <radialGradient id="g" cx="40%" cy="35%" r="70%">
        <stop offset="0" stop-color="%23ffffff"/>
        <stop offset="1" stop-color="%23f2efe7"/>
      </radialGradient>
    </defs>
    <rect width="128" height="128" rx="26" fill="url(%23g)"/>
    <circle cx="64" cy="64" r="46" fill="%23fff8" stroke="%23222" stroke-width="6"/>
    <circle cx="64" cy="64" r="6" fill="%23d43" stroke="%23222" stroke-width="3"/>
    <path d="M64 18 L50 40 L78 40 Z" fill="%23f0a" opacity=".0"/>
    <path d="M64 10 L46 40 L82 40 Z" fill="%23f4a63a" stroke="%23222" stroke-width="5" />
    <path d="M64 20 L64 64" stroke="%23222" stroke-width="5"/>
    <path d="M64 64 L100 64" stroke="%23222" stroke-width="4"/>
    <path d="M64 64 L82 94" stroke="%23222" stroke-width="4"/>
    <path d="M64 64 L44 90" stroke="%23222" stroke-width="4"/>
    <path d="M64 64 L28 64" stroke="%23222" stroke-width="4"/>
    <path d="M64 64 L48 34" stroke="%23222" stroke-width="4"/>
  </svg>' />

  <style>
    :root{
      --bg: #f3efe7;
      --card: rgba(255,255,255,.55);
      --ink: #1d1d1d;
      --muted: rgba(0,0,0,.55);
      --shadow: 0 18px 40px rgba(0,0,0,.12);
      --soft-shadow: 0 10px 26px rgba(0,0,0,.10);
      --btn: #f5d98f;
      --btn2: #ffffff;
      --line: rgba(0,0,0,.18);
      --radius: 22px;
      --wheelSize: min(78vw, 420px);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(900px 700px at 70% 20%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(900px 900px at 50% 80%, rgba(0,0,0,.05), transparent 55%),
        var(--bg);
      color:var(--ink);
      font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 20px 14px 40px;
    }

    .wrap{
      max-width: 560px;
      margin: 0 auto;
    }

    h1{
      margin: 8px 0 14px;
      text-align:center;
      font-size: 38px;
      letter-spacing: .5px;
      font-weight: 900;
    }

    .panel{
      background: var(--card);
      border: 2px solid rgba(0,0,0,.10);
      box-shadow: var(--shadow);
      border-radius: 26px;
      padding: 16px 14px 18px;
      backdrop-filter: blur(10px);
    }

    /* wheel stage */
    .wheelStage{
      position: relative;
      display:flex;
      justify-content:center;
      padding: 18px 0 10px;
    }

    /* pointer (尖端朝下，指向轉盤內) */
    .pointer{
      position:absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width:0; height:0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-top: 30px solid var(--ink);
      filter: drop-shadow(0 5px 0 rgba(0,0,0,.12));
      z-index: 30;
    }
    .pointer::after{
      content:"";
      position:absolute;
      left:-12px;
      top:-28px;
      width:0;height:0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 20px solid #f4a63a;
    }

    /* wheel */
    .wheelWrap{
      position: relative;
      width: var(--wheelSize);
      height: var(--wheelSize);
      display:grid;
      place-items:center;
    }

    .wheel{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      transform: rotate(0deg);
      will-change: transform;
      transition: transform 0ms;
      filter: drop-shadow(0 18px 16px rgba(0,0,0,.15));
    }

    /* 手繪外框：兩圈 + 不規則陰影 */
    .wheel::before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 80%, rgba(0,0,0,.14), transparent 58%),
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.75), transparent 55%);
      z-index:-1;
      filter: blur(1px);
    }

    .rim{
      position:absolute; inset:0;
      border-radius:50%;
      background:
        radial-gradient(circle, transparent 62%, rgba(0,0,0,.12) 63%, transparent 66%),
        radial-gradient(circle, rgba(255,255,255,.65) 0 58%, transparent 60%),
        radial-gradient(circle, transparent 70%, rgba(0,0,0,.12) 71%, transparent 74%);
      pointer-events:none;
    }

    .inkRing{
      position:absolute; inset:0;
      border-radius:50%;
      border: 6px solid rgba(0,0,0,.75);
      box-shadow:
        inset 0 0 0 4px rgba(255,255,255,.35),
        inset 0 0 0 10px rgba(0,0,0,.10);
      pointer-events:none;
      filter: blur(.15px);
    }

    /* 中心鈕 */
    .hub{
      position:absolute;
      width: 46px;
      height: 46px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.85), rgba(255,255,255,.2) 35%, transparent 36%),
        radial-gradient(circle at 60% 70%, rgba(0,0,0,.12), transparent 55%),
        #d94135;
      border: 4px solid rgba(0,0,0,.75);
      z-index: 8;
      box-shadow: 0 8px 12px rgba(0,0,0,.18);
    }

    /* 轉盤面（用 JS 置入 conic-gradient） */
    .face{
      position:absolute; inset:8px;
      border-radius:50%;
      overflow:hidden;
      background: #fff;
    }

    /* 水彩紙感顆粒（純 CSS） */
    .paperGrain{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 10% 20%, rgba(0,0,0,.04), transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(0,0,0,.03), transparent 40%),
        radial-gradient(circle at 30% 70%, rgba(0,0,0,.03), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(0,0,0,.03), transparent 45%);
      mix-blend-mode: multiply;
      pointer-events:none;
      opacity:.75;
    }

    /* 扇形分隔線（手繪感） */
    .spokes{
      position:absolute; inset:0;
      pointer-events:none;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
    }
    .spoke{
      position:absolute;
      left:50%; top:50%;
      width: 4px;
      height: 50%;
      background: rgba(0,0,0,.72);
      transform-origin: 50% 100%;
      border-radius: 12px;
      opacity:.95;
    }

    /* 文字標籤 */
    .labels{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 6;
    }
    .label{
      position:absolute;
      left:50%; top:50%;
      transform-origin: 0 0;
      font-weight: 900;
      font-size: 20px;
      color: rgba(0,0,0,.75);
      text-shadow:
        0 2px 0 rgba(255,255,255,.55),
        0 0 10px rgba(255,255,255,.35);
      white-space: nowrap;
      user-select:none;
      letter-spacing:.5px;
    }

    /* controls */
    .controls{
      margin-top: 10px;
      display:grid;
      gap: 10px;
    }

    .btnRow{
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    button{
      border: 2px solid rgba(0,0,0,.20);
      border-radius: 18px;
      padding: 12px 18px;
      font-weight: 900;
      font-size: 20px;
      background: var(--btn2);
      box-shadow: var(--soft-shadow);
      color: var(--ink);
      cursor: pointer;
    }
    button.primary{
      background: var(--btn);
      border-color: rgba(0,0,0,.18);
      min-width: 170px;
    }
    button.secondary{
      min-width: 170px;
    }
    button.ghost{
      background: rgba(255,255,255,.55);
      min-width: 170px;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
      padding: 10px 8px 0;
      border-top: 1px dashed rgba(0,0,0,.18);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
    }
    .field input{
      width:100%;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.70);
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 700;
      outline: none;
    }
    .field input:focus{
      border-color: rgba(0,0,0,.28);
      box-shadow: 0 0 0 3px rgba(245,217,143,.45);
    }

    .result{
      text-align:center;
      margin-top: 8px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.5px;
    }
    .hint{
      text-align:center;
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      line-height: 1.4;
    }

    @media (max-width: 420px){
      h1{ font-size: 34px; }
      .label{ font-size: 18px; }
      button{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>今天要選什麼？</h1>

    <div class="panel">
      <div class="wheelStage">
        <div class="pointer" aria-hidden="true"></div>

        <div class="wheelWrap">
          <div class="wheel" id="wheel">
            <div class="face" id="face">
              <div class="paperGrain"></div>
            </div>

            <div class="spokes" id="spokes"></div>
            <div class="labels" id="labels"></div>

            <div class="rim"></div>
            <div class="inkRing"></div>
            <div class="hub" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnSpin" disabled>開始</button>
        <button class="secondary" id="btnApply">套用選項</button>
        <button class="ghost" id="btnClear">清空</button>
      </div>

      <div class="result" id="result">結果是：—</div>
      <div class="hint" id="hint">
        至少填 2 個選項才可開始。<br/>
        2/3/5/7 個選項會自動倍增成 4/6/8 格，避免只剩對半。
      </div>

      <div class="grid" id="inputs">
        <!-- JS 產生 8 格 -->
      </div>
    </div>
  </div>

<script>
(() => {
  const wheel = document.getElementById('wheel');
  const face  = document.getElementById('face');
  const spokes = document.getElementById('spokes');
  const labels = document.getElementById('labels');
  const inputs = document.getElementById('inputs');
  const btnSpin = document.getElementById('btnSpin');
  const btnApply = document.getElementById('btnApply');
  const btnClear = document.getElementById('btnClear');
  const resultEl = document.getElementById('result');

  // 8 格輸入
  const inputEls = [];
  for (let i=1;i<=8;i++){
    const wrap = document.createElement('div');
    wrap.className = 'field';
    wrap.innerHTML = `
      <label>選項 ${i}</label>
      <input type="text" inputmode="text" autocomplete="off" placeholder="例如：火鍋" />
    `;
    const inp = wrap.querySelector('input');
    inp.addEventListener('input', updateStartState);
    inputEls.push(inp);
    inputs.appendChild(wrap);
  }

  // 手繪水彩配色（柔和）
  const baseColors = [
    '#f6d36a', // warm yellow
    '#bfe7d0', // mint
    '#bfe0f6', // sky
    '#c9c1f6', // lavender
    '#f2c2d7', // pink
    '#f3d7b7', // peach
    '#c8f0c2', // light green
    '#bfeff0', // aqua
  ];

  // 狀態
  let currentOptions = [];      // 最終用來轉的 options（會被倍增）
  let segmentCount = 6;         // 4/6/8
  let isSpinning = false;
  let rotation = 0;             // 目前角度（deg）

  // ===== 工具 =====
  function normalizeText(s){ return (s ?? '').trim(); }

  // 先快後慢（衝出去、慢慢停）
  function easeOutExpo(t){
    return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
  }

  // 取得使用者填的選項（去空）
  function getRawOptions(){
    return inputEls.map(i => normalizeText(i.value)).filter(Boolean);
  }

  // 倍增到 4/6/8 格，避免 2 格只剩對半
  function expandOptions(raw){
    const n = raw.length;
    if (n < 2) return { opts: [], count: 0 };

    let target;
    if (n === 2) target = 4;
    else if (n === 3) target = 6;
    else if (n === 4) target = 4;
    else if (n === 5) target = 8;
    else if (n === 6) target = 6;
    else if (n === 7) target = 8;
    else target = 8;

    const out = [];
    for (let i=0;i<target;i++){
      out.push(raw[i % n]);
    }
    return { opts: out, count: target };
  }

  // 建立 conic-gradient + 分隔線 + 標籤
  function renderWheel(opts){
    segmentCount = opts.length;

    // conic-gradient（每格一色）
    const segAngle = 360 / segmentCount;

    // 讓 0 號格「中心」對準指標（上方），因此從 -90deg 開始畫
    const stops = [];
    for (let i=0;i<segmentCount;i++){
      const c = baseColors[i % baseColors.length];
      const a0 = (i * segAngle).toFixed(3);
      const a1 = ((i+1) * segAngle).toFixed(3);

      // 做一點水彩深淺變化（同色系）
      // 這裡用多層透明白來「髒髒水彩」的感覺
      stops.push(`${c} ${a0}deg ${a1}deg`);
    }

    face.style.background =
      `conic-gradient(from -90deg, ${stops.join(',')})`;

    // 重新做 spokes
    spokes.innerHTML = '';
    for (let i=0;i<segmentCount;i++){
      const s = document.createElement('div');
      s.className = 'spoke';
      s.style.transform = `translate(-50%, -100%) rotate(${i * segAngle}deg)`;
      spokes.appendChild(s);
    }

    // 重新做 labels：文字保持正向（不跟著扭）
    labels.innerHTML = '';
    const r = 0.62; // 距離中心半徑比例
    for (let i=0;i<segmentCount;i++){
      const angle = i * segAngle + segAngle/2 - 90; // -90: 0 在上方
      const lab = document.createElement('div');
      lab.className = 'label';
      lab.textContent = opts[i];

      // 先旋轉到該扇形，再往外推，再反向旋轉讓字正
      lab.style.transform =
        `rotate(${angle}deg) translate(${(wheel.clientWidth/2)*r}px) rotate(${-angle}deg) translate(-50%, -50%)`;

      labels.appendChild(lab);
    }
  }

  // 依照指標（上方）回推目前選到哪一格
  function getSelectedIndex(rotDeg){
    const segAngle = 360 / segmentCount;
    // 指標固定在 0deg（上方），輪盤轉動 rotDeg
    // 轉盤上「正上方」對應的扇形 = 以 -rotDeg 來看原始扇形位置
    let a = ((-rotDeg) % 360 + 360) % 360;   // 0..359
    // a=0 表示扇形 0 的中心線在上方，但我們用分界線切割，
    // 加上半個扇形角度，讓取整對準中心
    a = (a + segAngle/2) % 360;
    return Math.floor(a / segAngle) % segmentCount;
  }

  // 套用按鈕：把輸入轉成輪盤
  function applyOptions(){
    const raw = getRawOptions();
    const { opts, count } = expandOptions(raw);

    if (count < 2){
      currentOptions = [];
      resultEl.textContent = '結果是：—';
      renderWheel(['請填至少兩個']); // 預設顯示
      wheel.style.opacity = 0.8;
      btnSpin.disabled = true;
      return;
    }

    currentOptions = opts.slice();
    wheel.style.opacity = 1;
    renderWheel(currentOptions);
    btnSpin.disabled = false;

    // 如果現在結果顯示的是舊的，先清一下
    resultEl.textContent = '結果是：—';
  }

  function updateStartState(){
    const raw = getRawOptions();
    btnSpin.disabled = (raw.length < 2) || isSpinning || (currentOptions.length < 2);
  }

  // 轉動：先快後慢
  function spin(){
    if (isSpinning) return;
    if (currentOptions.length < 2) return;

    isSpinning = true;
    btnSpin.disabled = true;
    btnApply.disabled = true;
    btnClear.disabled = true;

    const segAngle = 360 / segmentCount;

    // 隨機選一格（最終結果）
    const targetIndex = Math.floor(Math.random() * segmentCount);

    // 要讓 targetIndex 的「中心」停在上方指標
    // 目前 rotation 可能不是 0，先取現在的 rotation
    const start = rotation;

    // 將輪盤轉到目標：需要使得 getSelectedIndex(rotationEnd) === targetIndex
    // 我們可以直接把 rotationEnd 設成讓扇形中心對上方：
    // 扇形中心角（以 from -90deg 繪製）在：(-90 + targetIndex*seg + seg/2)
    // 要讓它到 0deg（上方），輪盤旋轉 rot 會把該角度 + rot
    // => (-90 + idx*seg + seg/2) + rot ≡ 0  (mod 360)
    // => rot ≡ 90 - (idx*seg + seg/2)
    const targetBase = 90 - (targetIndex * segAngle + segAngle/2);

    // 加多圈讓它轉夠爽：6~10 圈
    const extraTurns = (6 + Math.floor(Math.random()*5)) * 360;

    // 讓轉動方向固定為順時針（正角度）
    // 目前 rotation 可能已經很大，targetBase 落在 -180..180，改成對應到「下一個」順時針位置
    const currentNorm = ((start % 360) + 360) % 360;
    let targetNorm = ((targetBase % 360) + 360) % 360;

    // 要找一個 rotationEnd > start 的最小值，使 end%360 = targetNorm
    let deltaToTarget = targetNorm - currentNorm;
    if (deltaToTarget < 0) deltaToTarget += 360;

    const rotationEnd = start + extraTurns + deltaToTarget;

    // 動畫時間（ms）
    const duration = 3200 + Math.floor(Math.random()*600);
    const t0 = performance.now();

    function tick(now){
      const t = Math.min(1, (now - t0) / duration);
      const eased = easeOutExpo(t);

      rotation = start + (rotationEnd - start) * eased;
      wheel.style.transform = `rotate(${rotation}deg)`;

      if (t < 1){
        requestAnimationFrame(tick);
      } else {
        // 結果
        const idx = getSelectedIndex(rotation);
        resultEl.textContent = `結果是：${currentOptions[idx]}`;

        isSpinning = false;
        btnApply.disabled = false;
        btnClear.disabled = false;
        updateStartState();
      }
    }

    requestAnimationFrame(tick);
  }

  function clearAll(){
    inputEls.forEach(i => i.value = '');
    currentOptions = [];
    rotation = 0;
    wheel.style.transform = `rotate(0deg)`;
    resultEl.textContent = '結果是：—';
    renderWheel(['請填至少兩個']);
    wheel.style.opacity = 0.8;
    btnSpin.disabled = true;
  }

  // 綁定
  btnApply.addEventListener('click', applyOptions);
  btnSpin.addEventListener('click', spin);
  btnClear.addEventListener('click', clearAll);

  // 初始
  renderWheel(['請填至少兩個']);
  wheel.style.opacity = 0.8;
})();
</script>
</body>
</html>
